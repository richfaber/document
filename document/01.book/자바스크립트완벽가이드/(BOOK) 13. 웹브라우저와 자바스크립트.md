# 13장 웹 브라우저와 자바스크립트

## 웹 브라우저 환경

웹 브라우저가 제공하는 프로그래밍 환경을 이해해 보자

- 클라이언트 측 자바스크립트 코드를 위한 전역 객체와 전역 실행 컨텍스트로 사용되는 Window 객체
- 클라이언트 측 객체 계층 구조와 이 계층 구조의 일부를 이루는 문서 객체 모델(Document Object Model, DOM)
- 이벤트 구동 프로그래밍 모델

### 전역 실행 컨텍스트로서의 Window 객체

웹 브라우저의 주요 역할은 HTML 문서를 창에 출력하는 것이고, Window 객체는 브라우저창(또는 프레임)을 나타낸다.

Window 개체는 최상위 객체이고, 2개의 참조를 할 수 있는 `window` 와 `self` 속성이 있다.

```javascript
var answer = 42;    // 전역 변수를 선언하고 초기화
window.answer = 42; // Window 객체의 새로운 속성을 생성
```

### 클라이언트 측 객체 계층 구조와 DOM

Window 객체는 클라이언트 측 자바스크립트의 핵심 객체다. 모든 클라이언트 측 객체는 이 객체를 통해 접근한다.

- Document 객체를 가리키는 `document 속성`
- 창과 관련된 Location 객체를 가리키는 `location 속성`

Window 객체들에 대한 참조들은 `frames[]` 에 저장되는 데, 현재창의 첫번째 프레임은 `frames[0].document` 가 되고 두번째 프레임은 `frames[1].document` 가 된다.
(iframe 혹은 frameset html 페이지 들이 있을 경우 이것이 의미가 있다.)

Document 객체 에는 다른 객체들을 가리키는 속성들이 있다. 예를 들어 Form 객체를 접근하려면,

`window.document.forms[0]`

이렇게 함으로써 해당 `form` 에 접근을 할 수 있다.

** 클라이언트 측 객체 계층 구조와 레벨 0 DOM **

- 현재윈도우
    - self, window, parent, top 다양한 Window 객체
    - navigator : Navigator 객체
    - frames[] : Window 객체들의 배열
    - location : Location 객체
    - history : History 객체
    - document : Document 객체
        - form[] : Form 객체들의 배열
            - elements[] : HTML 폼 엘리먼트 객체들의 배열
                - Input
                - Select
                    - options[] : Option 객체들의 배열
                - Textarea
        - anchors[] : Anchor 객체들의 배열
        - links[] : Link 객체들의 배열
        - images[] : Image 객체들의 배열
        - applets[] : 애플릿들의 배열
    - screen : Screen 객체

이 클라이언트 측 객체 계층 구조는 문서 객체 모델(document object model, DOM) 으로 알려져 있고, 표준화 노력의 초점이 되어 왔다.

### 이벤트 구동 프로그래밍 모델

옛날얘기 이지만 프로그램은 데이터 묶음을 읽은 후, 컴퓨터 연산을 수행한 후 결과는 출력하는 방식 이였다.

근대는 이제 이벤트에 의해 구동되는 형태이다. 
마우스클릭을 하거나 키보드를 입력하거나 등의 비동기적으로 들어오는 사용자 입력에 따라 적절히 응답하는 형태로 진화 되었다.

웹브라우저는 더 그렇다. 브라우저에서 활용도가 높은 클라이언트 측 자바스크립트는 사용자 입력이 들어올 때 이벤트를 생성하여 프로그램에게 알려준다.

매우 다양한 이벤트가 있으며, 발생 시 적절한 이벤트 처리기 함수를 찾아 호출을 시도한다.

기존의 프로그래밍 모델은 잘 정의된 제어의 흐름에 따라 수행되는 `획일적 코드 블록` 이라면 이벤트 구동 프로그램은 `독립적 이벤트 처리기`(혹은 상호작용 가능한) 방식 이라 볼 수 있다.

### 웹상에서 자바스크립트의 열할

- 이미지 롤오버 같은 시각 효과를 생성하여 사용자의 페이지 탐색을 넌지시 도울 수 있다.
- 표의 열을 정렬함으로써 사용자가 원하는 것을 빨리 찾게 할 수 있다.
- 사용자가 문서의 내용을 깊이 파고들어감에 따라 선택적으로 어떤 내용은 감추고 또 어떤 내용은 더 자세히 노출하는 등의 작업을 할 수 있다.
- 웹 서버와 직접 통신하여 전체 페이지를 다시 읽어오지 않고도 새로운 정보가 표시될 수 있게 함으로써 브라우징 경험이 끊이지 않고 물 흐르듯 진행되게 할 수 있다.

### 겸손한 자바스크립트

- 자바스크립트는 HTML 과 CSS 에 참견 해서는 안된다.
- 자바스크립트 코드가 없어도 동작하도록 설계 되어야 한다.
- 웹접근성을 해치는 프로그래밍을 해서는 안된다.

## HTML에 스크립트 내장하기

자바스크립트 코드는 아래의 방법으로 내장할 수 있다.

- `<script>` 와 `</script>` 태그 사이
- `<script>` 태그의 `src` 속성을 이용한 외부파일 로드
- `onclick, onmouseover` 같은 HTML 속성값을 활용한 이벤트 처리기
- 특수한 `javascript:` 프로토콜을 활용한 방법

### `<script>` 태그

```javascript
<script>
    // 이 안에 코드를 둔다. 
</script>
```

xhtml에서는 `<script>` 태그 안의 내용을 스크립트로 인식하지 못하기 때문에, 편법이 필요 하다.

```javascript
<script>
<![CDATA[
    // 이안에 코드를 둔다.
]]
</script>
```

한 문서에 다수의 스크립트문을 사용할 수 있고, 선언 순서대로 실행 한다.

```javascript
<html>
<head>
    <title>Today's Date</title>
    <script language="javascript">
    // 이후에 사용하게 될 함수를 정의한다.
    function print_todays_date() {
        var d = new Date();                     // 오늘의 날짜와 시간을 얻어온다.
        document.write( d.toLocaleString() );   // 이것을 문서안에 끼워 넣는다.
    }
    </script>
</head>
<body>
The date and time are: <br />
<script language="javascript">
    print_todays_date();
</script>
</body>
</html>
```

위와 같이 `<head>` 태그 내에 선언한 스크립트 함수는 `<body>` 에서도 사용할 수 있다.

### 외부 파일에 저장된 스크립트

```javascript
<script src="../../scripts/util.js"></script>
```

이 파일은 순수하게 자바스크립트 파일만 있어야 한다. 이렇게 분리하는 것은 몇가지 장점이 있다.

- 커다란 블록의 자바스크립트 코드를 HTML 파일에서 제거할 수 있기 때문에 결과적으로 HTML 파일을 간단히 만들 수 있다. 즉 결과적으로 문서의 내용과 행동을 분리하게 된다. src 속성을 사용하는 것은 겸손한 자바스크립트 프로그래밍의 초석이 된다.
- 서로 다른 HTML 파일들이 공유하며 사용하는 함수나 자바스크립트 코드가 있다면, 이들을 하나의 파일에 저장하고 이를 필요로 하는 HTML 파일에서 읽어서 사용할 수 있다. 이것은 코드의 유지와 보수에 용이하다.
- 자바스크립트 함수들이 하나 이상의 페이지에 의해 사용된다면, 이들을 분리된 자바스크립트 파일에 놓아둠으로써 브라우저가 이들을 캐시에 저장하여 더 빨리 불러오게 할 수 있다. 여러 페이지에서 자바스크립트를 공유한다면 코드를 캐싱함으로써 절약할 수 있는 시간이, 브라우저가 처음 요청을 처리하기 위해 별도의 네트워크 연결을 열고 자바스크립트 파일을 다운로드 하는데 필요한 전송 지연 시간의 결점을 메우기에 충분하다.
- src 속성은 임의의 URL 을 값으로 사용하기 때문에 한 서버의 자바스크립트 프로그램이나 웹 페이지는 다른 웹서버에서 공개하는 코드를 취하여 사용할 수도 있다.

`동일 출처(same-origin) 보안 정책` 은 한 도메인의 문서 안에 있는 자바스크립트가 다른 도메인의 문서 내용과 상호 작용하는 것을 금지 한다.

> HTTP 접근제어 Cross-Origin Resource Sharing (CORS)

### 스크립트 언어 지정하기

자바스크립트가 그동안 널리 사용 되어온 것은 사실이지만, 스크립트 언어가 자바스크립트만 있는 것은 아니다.

대표적으로 마이크로소프트(Microsoft) 의 `Visual Basic Scripting Edition` 이 있다.

다양한 스크립트 언어로 인해 스크립트 헤더를 지정할 수가 있는데, 2가지 방법이 있다.

`<meta http-equiv="Content-Script-Type" content="text/javascript">`

이렇게 하면 전체 페이지에 걸쳐 적용을 할 수 있다. 
문서에 위의 구문이 선언되어 있지 않다면, 브라우저는 기본스크립트 라고 인식한다.

일부분 에만 적용할 때에는

`<script type="text/javascript"></script>`

이렇게 문서에 포함할 수도 있다.

전통적 MIME 타입은 `text/javascript` 이지만, 그 동안 사용된 다른 타입 으로는 "application/x-javascript" (`x-` 접두어는 표준이 아니라 실험적 이라는 것을 알리는 것) 가 있다.

`text/script` 타입은 널리 사용된다는 이유로 표준이 되었지만 정식적으로는 `application/javascript` 를 사용하기를 권장하고 있다.

표준에서 권고하는 적절한 메타대그와 스크립트 타입은 아래와 같다.

```html
<meta http-equiv="Content-Script-Type" content="application/javascript">
<script type="application/javascript"></script>
```

이전에는 `type` 을 지정하기 않았기 때문에, `language` 라는 비공식 속성을 사용 했다.

```javascript
<script language="javascript">
    // 자바스크립트 코드
</script>
```

만약 `VBScript` 를 작성한다면,

```javascript
<script language="VBScript">
</script>
```

호환성을 위해서 `type` 과 `language` 를 사용하자

```javascript
<script type="text/javascript" language="javascript"></script>
```

근래에는 이런 호환성 문제가 없다고 보기 때문에, `type` 명시만 사용하는 추세이다.

### defer 속성

페이지에 접속하면 브라우저는 HTML을 해석하기 시작하고, 스크립트를 만나면 모든 해석을 중단하고, 스크립트 실행을 기다려야만 한다.

`HTML 4표준` 에서는 이 문제를 해소하기 위해 `defer` 라는 속성을 정의 하고 있다.

이 속성을 만나게 되면, 스크립트 해석을 뒤로 미루고, 나머지 해석작업을 진행하고 나서 실행한다.
주의할 점은 스크립트의 실행순서를 위해서 사용하는 속성이 아님을 인지해야 한다.

이 속성은 단지, 스크립트 해석을 뒤로 미루라는 목적을 가지고 있는 것으로, 스크립트의 실행순서를 정할 목적으로 사용하는 것은 아니다.

### `<noscript>` 태그

스크립트가 작동하지 않는 환경에서 사용될 구문을 표현할 수 있다. 이러한 작업은 스크립트가 작동되지 않는 환경을 대응할 수 있기 때문에, 접근성을 높이는 효과를 얻을 수 있다.

### 오래된 브라우저에서 스크립트 감추기

스크립트가 적극 활용되지 않았던 시절에는 스크립트를 해석하지 않는 브라우저가 있을 정도였다.

그래서 주석을 사용함 으로써, 스크립트 해석을 하지 않는 브라우저를 위해서 편법을 사용 했다.

```html
<script language="javascript">
<!-- 스크립트를 가리기 위한 HTML 주석
    자바스크립트 코드
// -->
</script>
```

### HTML 의 이벤트 처리기

HTML의 속성을 통해서 자바스크립트 코드를 사용할 수 있는데, 사용자가 폼안의 체크박스를 클릭할 때 호출되는 이벤트 처리기를 등록하려면

```html
<input type="checkbox" name="options" value="giftwrap" onclick="giftwrap=this.checked;" />
```

이렇게 `onclick` 속성을 통해 자바스크립트 코드를 호출 하였다. 여러가지 속성을 통해 자바스크립트 코드를 사용할 수 있지만 아주 간단한 코드를 사용할 때에도 비추천 되고 있다.

## URL 안의 자바스크립트

`javascript: 모조 프로토콜` 을 사용해서 스크립트 코드를 사용할 수 있다.

모든 문장은 반드시 세미콜론으로 분리해야 하고 `//` 주석대신 `/* */` 을 사용해야 한다.

```javascript
javascript: var now = new Date(); "<h1>The time is:</h1>" + now;
```

브라우저에 주소대신 사용하는 방법으로 `alert` 같은 액션도 수행 된다.

```javascript
javascript:alert("Hello World")
```

페이지가 이동하는 것은 아니기 때문에, 현재 출력중인 문서의 내용이 바뀌지는 않는다.

이 프로토콜은 코드를 테스트 하는 용도로 많이 사용 되는 방법이다. 실제로 `a` 태그의 `href` 속성의 링크값으로 활용하던 이전 코드들은 비추천 되고 있다.

## 자바스크립트 프로그램의 실행

### 스크립트 실행

하나 이상의 스크립트 블록은 나타나는 순서대로 실행된다.
(예외로는 `defer`가 붙은 스크립트 블록)

`defer` 속성을 갖지 않는 모든 `<script>` 요소는 `document.write()` 메소드를 호출할 수 있다.
이 메서드로 전달된 텍스트는 문서 내의 그 스크립트가 위치한 곳에 삽입되고, 실행이 종료되면 HTML 해석기는 나머지 작업을 실행 한다.

### onload 이벤트 처리기

문서의 파싱이 끝나고 모든 스크립트가 실행된 후에 보조내용(이미지 같은것들) 이 전부 불려온 후에, `onload` 이벤트를 발생시켜 코드를 실행 한다.

`onload` 이벤트 처리기는 파싱이 완료된 후 실행하기 때문에 `document.write()` 메소드를 호출하면 `body` 의 내용이 사라진다.

### onunload 이벤트 처리기

사용자가 웹페이지를 떠나 다른 곳으로 이동할 때 `onunload` 이벤트 처리기를 구동한다.

이 이벤트를 떠나기전 대화상자를 띄우는 등의 목적으로 사용해서는 안된다. 금방 끝내야 하는 뒤처리 작업등을 하기 위한 목적 이므로, 대화상자를 띄우거나 사용자가 다른 페이지로 이동하는 것을 지연시키거나 방해해서는 안된다.







